<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PES ELITE | Admin Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #eaff00; --bg: #050508; --card: #12121a; --border: #222; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; }
        .dashboard { max-width: 1100px; margin: auto; }
        
        /* Header Stats */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-card i { color: var(--primary); font-size: 1.5rem; margin-bottom: 10px; }
        .stat-card h4 { margin: 5px 0; color: #888; font-size: 0.9rem; }
        .stat-card p { font-size: 1.5rem; font-weight: bold; margin: 0; }

        /* Main Grid */
        .admin-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        @media (max-width: 800px) { .admin-grid { grid-template-columns: 1fr; } }

        .panel { background: var(--card); border-radius: 15px; border: 1px solid var(--border); padding: 25px; position: relative; overflow: hidden; }
        .panel::before { content: ""; position: absolute; top: 0; right: 0; width: 4px; height: 100%; background: var(--primary); }
        .panel h3 { margin-top: 0; display: flex; align-items: center; gap: 10px; color: var(--primary); }

        /* Inputs & Buttons */
        label { display: block; margin-top: 15px; color: #aaa; font-size: 0.85rem; }
        select, input { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-top: 5px; box-sizing: border-box; outline: none; }
        select:focus, input:focus { border-color: var(--primary); }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; }
        .btn-save { background: var(--primary); color: black; }
        .btn-update { background: white; color: black; }
        .btn-danger { background: #ff3333; color: white; margin-top: 40px; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }

        /* Recent Activity List */
        .recent-list { margin-top: 15px; font-size: 0.85rem; }
        .recent-item { background: #000; padding: 10px; border-radius: 5px; margin-bottom: 8px; border-right: 2px solid var(--primary); display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="dashboard">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2 style="margin:0;"><i class="fas fa-user-shield"></i> PES ELITE <span style="color:var(--primary)">ADMIN</span></h2>
        <a href="league.html" target="_blank" style="color:var(--primary); text-decoration:none;"><i class="fas fa-external-link-alt"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙˆØ±ÙŠ</a>
    </div>

    <div class="stats-bar">
        <div class="stat-card">
            <i class="fas fa-futbol"></i>
            <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</h4>
            <p id="totalMatches">0</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <h4>Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h4>
            <p id="totalTeams">0</p>
        </div>
    </div>

    <div class="admin-grid">
        <div class="panel">
            <h3><i class="fas fa-trophy"></i> ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„</label>
                    <select id="t1"></select>
                </div>
                <div>
                    <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
                    <select id="t2"></select>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                <input type="number" id="s1" placeholder="Ø£Ù‡Ø¯Ø§Ù ØµØ§Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¶">
                <input type="number" id="s2" placeholder="Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø¶ÙŠÙ">
            </div>
            <button class="btn btn-save" onclick="recordMatch()">
                <i class="fas fa-check-circle"></i> Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ­ÙØ¸Ù‡Ø§
            </button>

            <div style="margin-top: 30px;">
                <h3><i class="fas fa-history"></i> Ø¢Ø®Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>
                <div id="recentActivity" class="recent-list"></div>
            </div>
        </div>

        <div>
            <div class="panel">
                <h3><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ù‡ÙˆÙŠØ© ÙØ±ÙŠÙ‚</h3>
                <label>Ø§Ø®ØªØ± Ø§Ù„Ø®Ø§Ù†Ø©</label>
                <select id="editSelect"></select>
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
                <input type="text" id="newName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØ¬Ùˆ</label>
                <input type="text" id="newLogo" placeholder="http://image-url.com">
                <button class="btn btn-update" onclick="updateTeam()">
                    <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                </button>
            </div>

            <button class="btn btn-danger" onclick="createNewLeague()">
                <i class="fas fa-trash-alt"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            </button>
        </div>
    </div>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
        authDomain: "pes-elite.firebaseapp.com",
        projectId: "pes-elite",
        storageBucket: "pes-elite.firebasestorage.app",
        messagingSenderId: "407069539120",
        appId: "1:407069539120:web:466249fa7f716266d9e6f5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Load Data
    function loadDashboard() {
        // Teams Sync
        db.collection("MainLeague").orderBy("id").onSnapshot(snap => {
            let options = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚...</option>';
            document.getElementById('totalTeams').innerText = snap.size;
            snap.forEach(doc => {
                options += `<option value="${doc.id}">${doc.data().name}</option>`;
            });
            document.getElementById('t1').innerHTML = options;
            document.getElementById('t2').innerHTML = options;
            document.getElementById('editSelect').innerHTML = options;
        });

        // History Sync
        db.collection("AllMatchesHistory").orderBy("time", "desc").limit(5).onSnapshot(snap => {
            let html = '';
            document.getElementById('totalMatches').innerText = snap.size; // This is a simplified count
            snap.forEach(doc => {
                const m = doc.data();
                html += `<div class="recent-item">
                    <span>${m.t1} ${m.s1} - ${m.s2} ${m.t2}</span>
                    <span style="color:#666">${new Date(m.time).toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'})}</span>
                </div>`;
            });
            document.getElementById('recentActivity').innerHTML = html || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø¨Ø¹Ø¯';
        });
    }

    async function recordMatch() {
        const id1 = document.getElementById('t1').value, id2 = document.getElementById('t2').value;
        const sc1 = parseInt(document.getElementById('s1').value), sc2 = parseInt(document.getElementById('s2').value);
        if(!id1 || !id2 || isNaN(sc1) || isNaN(sc2)) return alert("Ø¨Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
        if(id1 === id2) return alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ Ù„Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©!");

        const n1 = document.querySelector(`#t1 option[value="${id1}"]`).text;
        const n2 = document.querySelector(`#t2 option[value="${id2}"]`).text;

        try {
            await db.collection("AllMatchesHistory").add({ t1: n1, t2: n2, s1: sc1, s2: sc2, time: Date.now() });
            await updateStats(id1, sc1, sc2);
            await updateStats(id2, sc2, sc1);
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠ!");
            document.getElementById('s1').value = ''; document.getElementById('s2').value = '';
        } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!"); }
    }

    async function updateStats(id, gf, ga) {
        const ref = db.collection("MainLeague").doc(id);
        const d = (await ref.get()).data();
        let w = gf > ga ? 1 : 0, dr = gf === ga ? 1 : 0, l = gf < ga ? 1 : 0;
        await ref.update({
            played: (d.played || 0) + 1,
            w: (d.w || 0) + w, d: (d.d || 0) + dr, l: (d.l || 0) + l,
            gf: (d.gf || 0) + gf, ga: (d.ga || 0) + ga,
            pts: (d.pts || 0) + (w * 3 + dr),
            gd: (d.gd || 0) + (gf - ga)
        });
    }

    async function updateTeam() {
        const id = document.getElementById('editSelect').value;
        const name = document.getElementById('newName').value, logo = document.getElementById('newLogo').value;
        if(!id) return alert("Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡");
        let obj = {}; if(name) obj.name = name; if(logo) obj.logo = logo;
        await db.collection("MainLeague").doc(id).update(obj);
        alert("ğŸš€ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­");
        document.getElementById('newName').value = ''; document.getElementById('newLogo').value = '';
    }

    async function createNewLeague() {
        if(!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØ­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ÙØªØ­ Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ")) return;
        
        const loader = alert("Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯... Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø©");
        const oldL = await db.collection("MainLeague").get();
        for(let doc of oldL.docs) await db.collection("MainLeague").doc(doc.id).delete();
        const oldH = await db.collection("AllMatchesHistory").get();
        for(let doc of oldH.docs) await db.collection("AllMatchesHistory").doc(doc.id).delete();
        
        for(let i=1; i<=15; i++) {
            await db.collection("MainLeague").doc("team"+i).set({
                id: i, name: "ÙØ±ÙŠÙ‚ " + i, logo: "", played: 0, w:0, d:0, l:0, gf:0, ga:0, pts: 0, gd: 0
            });
        }
        alert("âœ¨ Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ø¯ÙŠÙƒ Ø¯ÙˆØ±ÙŠ Ø¬Ø¯ÙŠØ¯ ÙØ§Ø±Øº Ù…ÙƒÙˆÙ† Ù…Ù† 15 Ø®Ø§Ù†Ø©.");
    }

    loadDashboard();
</script>
</body>
</html>
