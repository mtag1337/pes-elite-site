<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PES ELITE | PRO ADMIN SYSTEM</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --ef-blue: #0014d3; --ef-yellow: #eaff00; --ef-pink: #ff007a;
            --dark-bg: #050508; --card-bg: #111118;
        }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--dark-bg); color: white; display: flex; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: #000; border-left: 1px solid #222; height: 100vh; position: fixed; padding: 20px; z-index: 100; overflow-y: auto; }
        .sidebar-header { font-family: 'Orbitron'; font-size: 22px; color: var(--ef-yellow); border-bottom: 2px solid var(--ef-pink); padding-bottom: 15px; margin-bottom: 20px; text-align: center; }
        
        .nav-link { 
            width: 100%; padding: 15px; margin-bottom: 8px; border-radius: 10px; border: none; 
            background: none; color: #888; text-align: right; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 12px; font-weight: bold;
        }
        .nav-link:hover, .nav-link.active { background: var(--ef-blue); color: white; box-shadow: 0 5px 15px rgba(0,20,211,0.4); }

        /* Content Area */
        .content { margin-right: 280px; flex: 1; padding: 40px; width: calc(100% - 280px); }
        .admin-section { display: none; animation: slideUp 0.4s ease; }
        .admin-section.active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card { background: var(--card-bg); padding: 25px; border-radius: 20px; border: 1px solid #222; margin-bottom: 25px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--card-bg); padding: 20px; border-radius: 15px; border-bottom: 4px solid var(--ef-blue); text-align: center; }
        .stat-box h3 { font-size: 14px; color: #666; margin: 0; }
        .stat-box p { font-size: 28px; font-family: 'Orbitron'; margin: 10px 0 0; color: var(--ef-yellow); }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-size: 14px; }
        input, select { width: 100%; padding: 12px; background: #1a1a25; border: 1px solid #333; color: white; border-radius: 8px; outline: none; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 12px; background: var(--ef-pink); border: none; color: white; font-weight: 900; border-radius: 8px; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-action:hover { filter: brightness(1.2); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #000; border-radius: 10px; overflow: hidden; }
        th { background: #1a1a25; padding: 15px; color: var(--ef-yellow); text-align: center; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #111; }
        .btn-small { padding: 5px 10px; border-radius: 5px; cursor: pointer; border: none; font-size: 12px; }
        .badge { padding: 4px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; }
        .bg-success { background: #00ff88; color: black; }
        .bg-warning { background: orange; color: black; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">PES ELITE HUB</div>
        <button class="nav-link active" onclick="openTab('overview')"><i class="fas fa-home"></i> الرئيسية</button>
        <button class="nav-link" onclick="openTab('tournaments')"><i class="fas fa-trophy"></i> إدارة البطولات</button>
        <button class="nav-link" onclick="openTab('requests')"><i class="fas fa-user-check"></i> طلبات الانضمام</button>
        <button class="nav-link" onclick="openTab('players')"><i class="fas fa-users"></i> إدارة اللاعبين</button>
        <button class="nav-link" onclick="openTab('results')"><i class="fas fa-file-invoice"></i> تسجيل النتائج</button>
        <button class="nav-link" onclick="openTab('news')"><i class="fas fa-rss"></i> الأخبار والسيستم</button>
        <button class="nav-link" style="color:var(--ef-pink); margin-top:50px;" onclick="auth.signOut()"><i class="fas fa-power-off"></i> خروج</button>
    </div>

    <div class="content">
        
        <div id="overview" class="admin-section active">
            <h1 style="font-family:'Orbitron'">DASHBOARD OVERVIEW</h1>
            <div class="stats-grid">
                <div class="stat-box"><h3>البطولات</h3><p id="stat-tours">0</p></div>
                <div class="stat-box"><h3>اللاعبين</h3><p id="stat-players">0</p></div>
                <div class="stat-box"><h3>المباريات</h3><p id="stat-matches">0</p></div>
                <div class="stat-box"><h3>الطلبات</h3><p id="stat-reqs">0</p></div>
            </div>
            <div class="glass-card">
                <h2>أحدث الأعضاء</h2>
                <table>
                    <thead><tr><th>اللاعب</th><th>E-Football ID</th><th>النقاط</th></tr></thead>
                    <tbody id="pListMain"></tbody>
                </table>
            </div>
        </div>

        <div id="tournaments" class="admin-section">
            <div class="glass-card">
                <h2><i class="fas fa-plus-circle"></i> إنشاء بطولة جديدة</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-group"><label>اسم البطولة</label><input type="text" id="tourName"></div>
                    <div class="form-group"><label>رابط اللوجو</label><input type="text" id="tourLogo" placeholder="https://..."></div>
                    <div class="form-group"><label>نوع البطولة</label><select id="tourType"><option value="league">دوري (نقاط)</option><option value="knockout">خروج مغلوب</option></select></div>
                    <div class="form-group"><label>الجائزة</label><input type="text" id="tourPrize"></div>
                </div>
                <button class="btn-action" onclick="addTournament()">إضافة البطولة ونشرها</button>
            </div>
            <div class="glass-card">
                <h2>البطولات الجارية</h2>
                <table><thead><tr><th>لوجو</th><th>الاسم</th><th>النوع</th><th>الإجراء</th></tr></thead><tbody id="tList"></tbody></table>
            </div>
        </div>

        <div id="requests" class="admin-section">
            <div class="glass-card">
                <h2><i class="fas fa-user-clock"></i> طلبات الانضمام المعلقة</h2>
                <table><thead><tr><th>اللاعب</th><th>البطولة</th><th>الحالة</th><th>الإجراء</th></tr></thead><tbody id="reqList"></tbody></table>
            </div>
        </div>

        <div id="players" class="admin-section">
            <div class="glass-card">
                <h2>إدارة اللاعبين وتعديل النقاط</h2>
                <table>
                    <thead><tr><th>اللاعب</th><th>النقاط</th><th>الصورة (URL)</th><th>الإجراء</th></tr></thead>
                    <tbody id="pListEdit"></tbody>
                </table>
            </div>
        </div>

        <div id="results" class="admin-section">
            <div class="glass-card">
                <h2>تسجيل نتيجة مباراة رسمية</h2>
                <div class="form-group"><label>اختر البطولة</label><select id="matchTourId"></select></div>
                <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:15px; align-items:center;">
                    <input type="text" id="resP1" placeholder="إيميل لاعب 1">
                    <span>VS</span>
                    <input type="text" id="resP2" placeholder="إيميل لاعب 2">
                    <input type="number" id="resS1" placeholder="أهداف 1">
                    <span>-</span>
                    <input type="number" id="resS2" placeholder="أهداف 2">
                </div>
                <button class="btn-action" style="background:var(--ef-blue)" onclick="saveMatch()">اعتماد النتيجة وتحديث النقاط</button>
            </div>
        </div>

        <div id="news" class="admin-section">
            <div class="glass-card">
                <h2>تحديث شريط الأخبار العالمي</h2>
                <input type="text" id="globalNews" placeholder="اكتب الخبر هنا...">
                <button class="btn-action" onclick="saveNews()">نشر الخبر للمستخدمين</button>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
            authDomain: "pes-elite.firebaseapp.com",
            projectId: "pes-elite",
            storageBucket: "pes-elite.firebasestorage.app",
            messagingSenderId: "407069539120",
            appId: "1:407069539120:web:466249fa7f716266d9e6f5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        // حماية الأدمن
        auth.onAuthStateChanged(user => {
            if(!user || user.email !== "mtag1337@gmail.com") window.location.href="login.html";
            else { loadStats(); loadTournaments(); loadRequests(); loadPlayers(); }
        });

        function openTab(id) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // جلب الإحصائيات واللاعبين
        function loadStats() {
            db.collection("players").orderBy("points", "desc").onSnapshot(s => {
                document.getElementById('stat-players').innerText = s.size;
                let hMain = ""; let hEdit = "";
                s.forEach(d => {
                    const p = d.data();
                    hMain += `<tr><td>${p.nickname}</td><td>${p.efootballId || 'N/A'}</td><td>${p.points || 0}</td></tr>`;
                    hEdit += `<tr>
                        <td>${p.nickname}</td>
                        <td><input type="number" value="${p.points || 0}" onchange="updateField('players','${d.id}','points',this.value)"></td>
                        <td><input type="text" value="${p.avatar || ''}" onchange="updateField('players','${d.id}','avatar',this.value)"></td>
                        <td><button class="btn-small" style="background:red" onclick="deleteDoc('players','${d.id}')">حذف</button></td>
                    </tr>`;
                });
                document.getElementById('pListMain').innerHTML = hMain;
                document.getElementById('pListEdit').innerHTML = hEdit;
            });
            db.collection("tournaments").onSnapshot(s => document.getElementById('stat-tours').innerText = s.size);
            db.collection("requests").where("status","==","pending").onSnapshot(s => document.getElementById('stat-reqs').innerText = s.size);
        }

        // إدارة البطولات
        async function addTournament() {
            const t = { 
                name: document.getElementById('tourName').value, 
                logo: document.getElementById('tourLogo').value, 
                type: document.getElementById('tourType').value, 
                prize: document.getElementById('tourPrize').value, 
                active: true,
                createdAt: new Date()
            };
            await db.collection("tournaments").add(t);
            Swal.fire('تم!', 'البطولة أصبحت متاحة للاعبين', 'success');
        }

        function loadTournaments() {
            db.collection("tournaments").onSnapshot(s => {
                let h = ""; let opt = "";
                s.forEach(d => {
                    const t = d.data();
                    h += `<tr><td><img src="${t.logo}" width="40" style="border-radius:5px"></td><td>${t.name}</td><td>${t.type}</td><td><button class="btn-small" style="background:#333" onclick="deleteDoc('tournaments','${d.id}')">حذف</button></td></tr>`;
                    opt += `<option value="${d.id}">${t.name}</option>`;
                });
                document.getElementById('tList').innerHTML = h;
                document.getElementById('matchTourId').innerHTML = opt;
            });
        }

        // إدارة الطلبات
        function loadRequests() {
            db.collection("requests").onSnapshot(s => {
                let h = "";
                s.forEach(d => {
                    const r = d.data();
                    h += `<tr><td>${r.playerNickname || r.playerEmail}</td><td>${r.tournamentName}</td><td><span class="badge ${r.status=='pending'?'bg-warning':'bg-success'}">${r.status}</span></td>
                    <td><button class="btn-small" style="background:green" onclick="approveReq('${d.id}')">قبول</button></td></tr>`;
                });
                document.getElementById('reqList').innerHTML = h || "<tr><td colspan='4'>لا توجد طلبات</td></tr>";
            });
        }

        async function approveReq(id) {
            await db.collection("requests").doc(id).update({status: 'accepted'});
            Swal.fire('تم!', 'تم قبول اللاعب في البطولة', 'success');
        }

        // وظائف عامة
        async function updateField(col, id, field, val) {
            let finalVal = isNaN(val) ? val : parseInt(val);
            await db.collection(col).doc(id).update({[field]: finalVal});
        }

        async function deleteDoc(c, i) {
            if(confirm("هل أنت متأكد من الحذف؟")) await db.collection(c).doc(i).delete();
        }

        async function saveNews() {
            const news = document.getElementById('globalNews').value;
            await db.collection("settings").doc("global").set({news: news}, {merge:true});
            Swal.fire('نشر!', 'تم تحديث شريط الأخبار', 'success');
        }

        async function saveMatch() {
            const m = {
                tourId: document.getElementById('matchTourId').value,
                p1: document.getElementById('resP1').value,
                p2: document.getElementById('resP2').value,
                s1: parseInt(document.getElementById('resS1').value),
                s2: parseInt(document.getElementById('resS2').value),
                date: new Date()
            };
            await db.collection("matches").add(m);
            Swal.fire('تم!', 'سجلت النتيجة بنجاح', 'success');
        }
    </script>
</body>
</html>
