<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إدارة PES ELITE | التحكم الكامل</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --p: #e1ff00; --bg: #050508; --card: #111118; --danger: #ff4d4d; }
        body { background: var(--bg); color: white; font-family: 'Cairo'; margin: 0; padding: 20px; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        h2 { color: var(--p); font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; font-family: 'Cairo'; }
        input, select { background: #000; color: #fff; border: 1px solid #333; }
        button { cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-add { background: var(--p); color: #000; }
        .btn-del { background: var(--danger); color: #fff; padding: 5px; font-size: 12px; width: auto; }
        .item-list { max-height: 200px; overflow-y: auto; background: #000; padding: 10px; border-radius: 8px; }
        .list-entry { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

<h1><i class="fas fa-user-shield"></i> مركز إدارة العمليات</h1>

<div class="admin-grid">

    <div class="card">
        <h2><i class="fas fa-trophy"></i> إدارة البطولات الحالية</h2>
        <input type="text" id="tTitle" placeholder="اسم البطولة">
        <input type="text" id="tPrize" placeholder="الجائزة">
        <button class="btn-add" onclick="createT()">إنشاء بطولة جديدة</button>
        <hr>
        <div id="tList" class="item-list"></div>
    </div>

    <div class="card">
        <h2><i class="fas fa-table"></i> إعدادات الدوري العام</h2>
        <p style="font-size: 12px; color: #888;">أضف نتيجة لتحديث الجدول تلقائياً</p>
        <select id="p1Select"><option value="">اللاعب الأول</option></select>
        <select id="p2Select"><option value="">اللاعب الثاني</option></select>
        <div style="display: flex; gap: 10px;">
            <input type="number" id="s1" placeholder="أهداف 1">
            <input type="number" id="s2" placeholder="أهداف 2">
        </div>
        <button class="btn-add" style="background: #00bfff; color: white;" onclick="submitMatch()">تسجيل النتيجة وتحديث الترتيب</button>
    </div>

    <div class="card">
        <h2><i class="fas fa-users-cog"></i> توزيع الفرق والتصاريح</h2>
        <select id="allPlayersList"><option value="">اختر لاعباً</option></select>
        <input type="text" id="teamName" placeholder="اسم الفريق المسند (مثلاً: ريال مدريد)">
        <button class="btn-add" style="background: #ffffff; color: #000;" onclick="assignTeam()">إسناد الفريق للاعب</button>
    </div>

    <div class="card">
        <h2><i class="fas fa-id-card"></i> طلبات معلقة</h2>
        <div id="reqs" class="item-list"></div>
    </div>

</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
        authDomain: "pes-elite.firebaseapp.com",
        projectId: "pes-elite",
        storageBucket: "pes-elite.firebasestorage.app",
        messagingSenderId: "407069539120",
        appId: "1:407069539120:web:466249fa7f716266d9e6f5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // تحميل البيانات الأساسية عند الفتح
    window.onload = () => {
        loadTournaments();
        loadPlayers();
        loadRequests();
    };

    // --- وظائف البطولات ---
    async function createT() {
        const title = document.getElementById('tTitle').value;
        const prize = document.getElementById('tPrize').value;
        if (title) {
            await db.collection("tournaments").add({ title, prize, status: "open", time: Date.now() });
            alert("تمت الإضافة");
            location.reload();
        }
    }

    function loadTournaments() {
        db.collection("tournaments").onSnapshot(snap => {
            const container = document.getElementById('tList');
            container.innerHTML = "";
            snap.forEach(doc => {
                container.innerHTML += `
                    <div class="list-entry">
                        <span>${doc.data().title}</span>
                        <button class="btn-del" onclick="deleteDoc('tournaments', '${doc.id}')">حذف</button>
                    </div>`;
            });
        });
    }

    // --- وظائف الدوري والمباريات ---
    async function submitMatch() {
        const p1Id = document.getElementById('p1Select').value;
        const p2Id = document.getElementById('p2Select').value;
        const score1 = parseInt(document.getElementById('s1').value);
        const score2 = parseInt(document.getElementById('s2').value);

        if (!p1Id || !p2Id || isNaN(score1)) return alert("بيانات ناقصة");

        // 1. تسجيل المباراة في سجل المباريات
        await db.collection("leagueMatches").add({
            p1Id, p2Id, 
            p1Name: document.getElementById('p1Select').options[document.getElementById('p1Select').selectedIndex].text,
            p2Name: document.getElementById('p2Select').options[document.getElementById('p2Select').selectedIndex].text,
            p1Score: score1, p2Score: score2,
            time: Date.now()
        });

        // 2. تحديث جدول الدوري (leaguePlayers)
        await updateLeagueTable(p1Id, score1, score2);
        await updateLeagueTable(p2Id, score2, score1);

        alert("تم تحديث الدوري بنجاح!");
    }

    async function updateLeagueTable(uid, gf, ga) {
        const ref = db.collection("leaguePlayers").doc(uid);
        const doc = await ref.get();
        let data = doc.exists ? doc.data() : { pts: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, played: 0 };

        data.played += 1;
        data.gf += gf;
        data.ga += ga;
        if (gf > ga) { data.pts += 3; data.w += 1; }
        else if (gf === ga) { data.pts += 1; data.d += 1; }
        else { data.l += 1; }
        data.gd = data.gf - data.ga;

        await ref.set(data, { merge: true });
    }

    // --- وظائف عامة ---
    function loadPlayers() {
        db.collection("players").get().then(snap => {
            const s1 = document.getElementById('p1Select');
            const s2 = document.getElementById('p2Select');
            const s3 = document.getElementById('allPlayersList');
            snap.forEach(doc => {
                let opt = `<option value="${doc.id}">${doc.data().nickname || doc.data().name}</option>`;
                s1.innerHTML += opt; s2.innerHTML += opt; s3.innerHTML += opt;
            });
        });
    }

    async function assignTeam() {
        const uid = document.getElementById('allPlayersList').value;
        const team = document.getElementById('teamName').value;
        if(uid && team) {
            await db.collection("players").doc(uid).update({ assignedTeam: team });
            alert("تم إسناد الفريق");
        }
    }

    function deleteDoc(col, id) {
        if(confirm("حذف نهائي؟")) db.collection(col).doc(id).delete();
    }

    function loadRequests() {
        db.collection("playerRequests").onSnapshot(snap => {
            const container = document.getElementById('reqs');
            container.innerHTML = "";
            snap.forEach(doc => {
                container.innerHTML += `
                    <div class="list-entry">
                        <span>${doc.data().playerName} -> ${doc.data().tournamentName}</span>
                        <button class="btn-del" style="background:green" onclick="deleteDoc('playerRequests', '${doc.id}')">قبول/مسح</button>
                    </div>`;
            });
        });
    }
</script>
</body>
</html>
