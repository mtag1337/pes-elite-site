<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PES ELITE | PLAYER HUB</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --ef-blue: #0014d3; --ef-yellow: #eaff00; --ef-pink: #ff007a; --main-bg: #05050a; --glass: rgba(255, 255, 255, 0.05); }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--main-bg); color: white; overflow-x: hidden; }
        
        /* Navbar */
        .navbar { padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-user-img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--ef-blue); object-fit: cover; cursor: pointer; }

        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        .glass-panel { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px; transition: 0.3s; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; }
        .stat-item i { color: var(--ef-blue); font-size: 20px; margin-bottom: 10px; }
        .stat-item h3 { font-family: 'Orbitron'; margin: 5px 0; color: var(--ef-yellow); }

        /* Buttons */
        .btn-main { background: var(--ef-blue); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; font-family: 'Cairo'; }
        .btn-main:hover { filter: brightness(1.2); box-shadow: 0 0 15px var(--ef-blue); }

        /* Profile Overlay */
        #profileOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: var(--main-bg); z-index: 2000; padding: 20px; overflow-y: auto; }
        
        .avatar-edit-box { text-align: center; max-width: 500px; margin: auto; }
        .big-avatar { width: 130px; height: 130px; border-radius: 50%; border: 4px solid var(--ef-blue); object-fit: cover; margin-bottom: 20px; background: #222; }
        
        .input-dark { background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
        
        .tour-card { text-align: center; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 15px; border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo" style="font-family:'Orbitron'; font-weight:900; font-size:20px;">PES <span style="color:var(--ef-blue)">ELITE</span></div>
        <div style="display:flex; align-items:center; gap:12px;">
            <span id="navNickname" style="font-weight:bold;">...</span>
            <img id="navAvatar" src="https://via.placeholder.com/150" class="nav-user-img" onclick="openProfile()">
        </div>
    </nav>

    <div class="container">
        <div class="glass-panel stats-grid">
            <div class="stat-item"><i class="fas fa-star"></i><h3 id="statPoints">0</h3><p>نقاط</p></div>
            <div class="stat-item"><i class="fas fa-gamepad"></i><h3 id="statMatches">0</h3><p>مباريات</p></div>
            <div class="stat-item"><i class="fas fa-trophy"></i><h3 id="statRank">#--</h3><p>المركز</p></div>
        </div>

        <h3 style="margin-bottom:15px;"><i class="fas fa-shield-alt" style="color:var(--ef-pink)"></i> البطولات النشطة</h3>
        <div id="tournamentsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            </div>
    </div>

    <div id="profileOverlay">
        <div style="max-width: 600px; margin: auto;">
            <button onclick="closeProfile()" style="background:none; border:none; color:white; font-size:22px; cursor:pointer;"><i class="fas fa-times"></i> إغلاق</button>
            
            <div class="glass-panel avatar-edit-box" style="margin-top:20px;">
                <img id="bigAvatar" src="https://via.placeholder.com/150" class="big-avatar">
                <h2 id="profileName" style="font-family:'Orbitron'; margin-bottom:20px;">PLAYER NAME</h2>
                
                <div style="text-align: right;">
                    <label style="font-size:12px; color:#aaa;">رابط الصورة المباشر (مثل ImgBB):</label>
                    <input type="text" id="avatarInput" class="input-dark" placeholder="https://link-to-image.jpg">
                    <button class="btn-main" onclick="updateAvatar()">تحديث الصورة فوراً</button>
                </div>
            </div>

            <div class="glass-panel">
                <h4><i class="fas fa-id-card"></i> بيانات الحساب</h4>
                <p id="userEmail" style="color:#aaa; font-size:14px;"></p>
                <div style="margin-top:15px;">
                    <label style="font-size:12px; color:#aaa;">E-Football ID:</label>
                    <input type="text" id="efIDInput" class="input-dark" placeholder="سيظهر هنا بعد الحفظ">
                    <button id="saveIDBtn" class="btn-main" onclick="updateEFID()">حفظ الـ ID</button>
                </div>
            </div>
            
            <button onclick="auth.signOut()" style="width:100%; background:#300; color:#ff4d4d; border:1px solid #500; padding:10px; border-radius:10px; cursor:pointer; font-weight:bold;">تسجيل الخروج</button>
        </div>
    </div>

    <script>
        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
            authDomain: "pes-elite.firebaseapp.com",
            projectId: "pes-elite",
            storageBucket: "pes-elite.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        let currentUserDocId = null;

        // التحقق من تسجيل الدخول وجلب البيانات لحظياً
        auth.onAuthStateChanged(user => {
            if (user) {
                db.collection("players").where("email", "==", user.email).onSnapshot(snap => {
                    if (!snap.empty) {
                        const doc = snap.docs[0];
                        currentUserDocId = doc.id;
                        const data = doc.data();
                        updateUI(data);
                    }
                });
                loadTournaments();
            } else {
                window.location.href = "login.html";
            }
        });

        // تحديث الواجهة عند أي تغيير في الداتابيز
        function updateUI(data) {
            document.getElementById('navNickname').innerText = data.nickname || "لاعب";
            document.getElementById('profileName').innerText = data.nickname || "لاعب";
            document.getElementById('statPoints').innerText = data.points || 0;
            document.getElementById('statMatches').innerText = data.matchesPlayed || 0;
            document.getElementById('userEmail').innerText = data.email;
            
            // تحديث الصور مع "صورة احتياطية" لو الرابط باظ
            const userAvatar = data.avatar || 'https://via.placeholder.com/150';
            document.getElementById('navAvatar').src = userAvatar;
            document.getElementById('bigAvatar').src = userAvatar;

            if(data.efootballId) {
                document.getElementById('efIDInput').value = data.efootballId;
                document.getElementById('efIDInput').disabled = true;
                document.getElementById('saveIDBtn').style.display = 'none';
            }
        }

        // تحديث الصورة (التفاعل اللحظي)
        async function updateAvatar() {
            const url = document.getElementById('avatarInput').value.trim();
            if (!url.startsWith('http')) return Swal.fire('خطأ', 'الرابط غير صحيح', 'error');

            try {
                await db.collection("players").doc(currentUserDocId).update({ avatar: url });
                document.getElementById('avatarInput').value = "";
                Swal.fire({ icon: 'success', title: 'تم التحديث!', toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
            } catch (e) {
                Swal.fire('عذراً', 'لا تملك صلاحية التعديل (تأكد من الـ Rules)', 'error');
            }
        }

        // تحديث الـ ID
        async function updateEFID() {
            const idVal = document.getElementById('efIDInput').value.trim();
            if (!idVal) return;
            await db.collection("players").doc(currentUserDocId).update({ efootballId: idVal });
            Swal.fire('تم الحفظ', 'تم ربط حسابك بنجاح', 'success');
        }

        // جلب البطولات من الداتابيز
        async function loadTournaments() {
            db.collection("tournaments").onSnapshot(snap => {
                let html = "";
                snap.forEach(doc => {
                    const t = doc.data();
                    html += `
                    <div class="tour-card glass-panel">
                        <img src="${t.logo || 'https://via.placeholder.com/100'}" style="width:100%; height:100px; object-fit:cover; border-radius:10px;">
                        <h4>${t.name}</h4>
                        <button onclick="joinTour('${doc.id}', '${t.name}')" class="btn-main" style="padding:5px; font-size:12px;">طلب انضمام</button>
                    </div>`;
                });
                document.getElementById('tournamentsList').innerHTML = html || "<p>لا توجد بطولات حالياً</p>";
            });
        }

        async function joinTour(tid, tname) {
            await db.collection("requests").add({
                playerEmail: auth.currentUser.email,
                tournamentId: tid,
                tournamentName: tname,
                status: "pending",
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            Swal.fire('تم!', 'طلبك قيد المراجعة الآن', 'success');
        }

        function openProfile() { document.getElementById('profileOverlay').style.display = 'block'; }
        function closeProfile() { document.getElementById('profileOverlay').style.display = 'none'; }
    </script>
</body>
</html>
