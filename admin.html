<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>PES ELITE | إمبراطورية الإدارة</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --main: #eaff00; --bg: #050507; --card: #111116; --danger: #ff3e3e; --accent: #00f2ff; }
        body { background: var(--bg); color: white; font-family: 'Cairo', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; opacity: 0; transition: 0.5s; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: var(--card); border-left: 1px solid #222; padding: 20px; display: flex; flex-direction: column; }
        .nav-btn { padding: 12px 15px; margin: 5px 0; border-radius: 10px; cursor: pointer; border: 1px solid transparent; background: none; color: #888; text-align: right; font-size: 15px; transition: 0.3s; width: 100%; }
        .nav-btn i { margin-left: 10px; width: 20px; }
        .nav-btn.active { background: var(--main); color: #000; font-weight: bold; }

        /* Workspace */
        .workspace { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s; }
        .active-sec { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards & UI */
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; font-family: 'Cairo'; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; transition: 0.2s; }
        .btn-main { background: var(--main); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #000; color: var(--main); padding: 12px; border: 1px solid #222; }
        td { padding: 10px; border: 1px solid #222; text-align: center; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; }
        .status-pending { background: orange; color: black; }
        .status-accepted { background: #00ff88; color: black; }
    </style>
</head>
<body>

<aside class="sidebar">
    <h2 style="color:var(--main); text-align:center; margin-bottom:30px;">ELITE PANEL</h2>
    <button class="nav-btn active" onclick="openSec('dashSec', this)"><i class="fas fa-home"></i> نظرة عامة</button>
    <button class="nav-btn" onclick="openSec('tourManager', this)"><i class="fas fa-trophy"></i> إدارة البطولات</button>
    <button class="nav-btn" onclick="openSec('reqSec', this)"><i class="fas fa-user-plus"></i> طلبات الانضمام</button>
    <button class="nav-btn" onclick="openSec('playerManager', this)"><i class="fas fa-users"></i> قاعدة اللاعبين</button>
    <button class="nav-btn" onclick="openSec('msgSec', this)"><i class="fas fa-paper-plane"></i> الرسائل الخاصة</button>
    <button class="nav-btn" onclick="openSec('settingsSec', this)"><i class="fas fa-cog"></i> الإعدادات والأخبار</button>
    
    <button class="btn btn-danger" onclick="auth.signOut()" style="margin-top:auto">خروج آمن</button>
</aside>

<main class="workspace">
    <div id="dashSec" class="section active-sec">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
            <div class="card"><h3>إجمالي اللاعبين</h3><p id="statPlayers" style="font-size:32px; color:var(--main)">0</p></div>
            <div class="card"><h3>البطولات</h3><p id="statTours" style="font-size:32px; color:var(--accent)">0</p></div>
            <div class="card"><h3>طلبات معلقة</h3><p id="statReqs" style="font-size:32px; color:var(--danger)">0</p></div>
        </div>
    </div>

    <div id="tourManager" class="section">
        <div class="card">
            <h3>إضافة بطولة جديدة</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input type="text" id="tTitle" placeholder="اسم البطولة (مثلاً: كأس النخبة)">
                <input type="text" id="tPrize" placeholder="الجائزة (مثلاً: 5000 GP)">
                <input type="datetime-local" id="tDate">
                <input type="number" id="tMax" placeholder="الحد الأقصى للاعبين">
            </div>
            <button class="btn btn-main" style="margin-top:10px;" onclick="createNewTour()">إنشاء البطولة</button>
        </div>
        <div id="toursList"></div>
    </div>

    <div id="reqSec" class="section">
        <h3>مراجعة طلبات الاشتراك</h3>
        <div class="card">
            <table>
                <thead>
                    <tr><th>اللاعب</th><th>البطولة</th><th>الحالة</th><th>الإجراء</th></tr>
                </thead>
                <tbody id="requestsTable"></tbody>
            </table>
        </div>
    </div>

    <div id="playerManager" class="section">
        <h3>إدارة جميع المسجلين</h3>
        <div class="card">
            <input type="text" id="searchPlayer" placeholder="ابحث عن لاعب بالاسم..." oninput="filterPlayers()">
            <table style="font-size: 14px;">
                <thead>
                    <tr><th>الاسم</th><th>الـ ID</th><th>GP</th><th>Rating</th><th>الإجراء</th></tr>
                </thead>
                <tbody id="allPlayersTable"></tbody>
            </table>
        </div>
    </div>

    <div id="msgSec" class="section">
        <div class="card">
            <h3>إرسال رسالة خاصة للاعب</h3>
            <input type="text" id="targetUID" placeholder="ضع هنا الـ UID الخاص باللاعب">
            <textarea id="privateMsgText" rows="4" placeholder="اكتب رسالتك هنا..."></textarea>
            <button class="btn btn-main" onclick="sendPrivateMsg()">إرسال الرسالة</button>
        </div>
    </div>

    <div id="settingsSec" class="section">
        <div class="card">
            <h3>تحديث شريط الأخبار</h3>
            <textarea id="newsContent" rows="3"></textarea>
            <button class="btn btn-main" onclick="updateNews()">نشر الخبر</button>
        </div>
    </div>
</main>

<script>
    // تكوين Firebase (استخدم بياناتك)
    const firebaseConfig = {
        apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
        authDomain: "pes-elite.firebaseapp.com",
        projectId: "pes-elite",
        storageBucket: "pes-elite.firebasestorage.app",
        messagingSenderId: "407069539120",
        appId: "1:407069539120:web:466249fa7f716266d9e6f5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const ADMIN_EMAIL = "mtag1337@gmail.com";

    auth.onAuthStateChanged(user => {
        if (user && user.email === ADMIN_EMAIL) {
            document.body.style.opacity = "1";
            initAdmin();
        } else {
            window.location.href = "login.html";
        }
    });

    function openSec(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active-sec'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active-sec');
        btn.classList.add('active');
    }

    function initAdmin() {
        loadStats();
        loadTours();
        loadRequests();
        loadPlayers();
    }

    // --- الوظائف الأساسية ---

    function loadStats() {
        db.collection("players").onSnapshot(s => document.getElementById('statPlayers').innerText = s.size);
        db.collection("tournaments").onSnapshot(s => document.getElementById('statTours').innerText = s.size);
        db.collection("playerRequests").where("status","==","pending").onSnapshot(s => document.getElementById('statReqs').innerText = s.size);
    }

    async function createNewTour() {
        const title = document.getElementById('tTitle').value;
        const prize = document.getElementById('tPrize').value;
        const max = document.getElementById('tMax').value;
        const date = document.getElementById('tDate').value;

        if(!title || !max) return alert("أكمل البيانات!");

        await db.collection("tournaments").add({
            title: title,
            prize: prize,
            maxPlayers: parseInt(max),
            joinedPlayers: [], // القائمة تبدأ فارغة
            startDate: date,
            status: "open",
            createdAt: Date.now()
        });
        alert("تم إنشاء البطولة بنجاح!");
    }

    function loadTours() {
        db.collection("tournaments").orderBy("createdAt", "desc").onSnapshot(snap => {
            const container = document.getElementById('toursList');
            container.innerHTML = "";
            snap.forEach(doc => {
                const t = doc.data();
                container.innerHTML += `
                    <div class="card" style="border-right: 5px solid var(--accent)">
                        <div style="display:flex; justify-content:space-between">
                            <h4>${t.title} (${t.joinedPlayers.length}/${t.maxPlayers})</h4>
                            <button onclick="deleteTour('${doc.id}')" class="btn-danger btn">حذف</button>
                        </div>
                        <p style="font-size:12px; color:#777">الجائزة: ${t.prize} | الموعد: ${t.startDate}</p>
                    </div>
                `;
            });
        });
    }

    function loadRequests() {
        db.collection("playerRequests").onSnapshot(snap => {
            const table = document.getElementById('requestsTable');
            table.innerHTML = "";
            snap.forEach(doc => {
                const r = doc.data();
                table.innerHTML += `
                    <tr>
                        <td>${r.playerName}</td>
                        <td>${r.tournamentName}</td>
                        <td><span class="status-badge status-${r.status}">${r.status}</span></td>
                        <td>
                            ${r.status === 'pending' ? 
                            `<button onclick="handleReq('${doc.id}', '${r.uid}', '${r.tournamentName}', true)" class="btn btn-main">قبول</button>
                             <button onclick="handleReq('${doc.id}', '${r.uid}', '${r.tournamentName}', false)" class="btn btn-danger">رفض</button>` 
                            : 'تمت المعالجة'}
                        </td>
                    </tr>
                `;
            });
        });
    }

    async function handleReq(reqId, playerUID, tourName, isAccept) {
        if(isAccept) {
            // 1. تحديث حالة الطلب
            await db.collection("playerRequests").doc(reqId).update({ status: "accepted" });
            
            // 2. إرسال إشعار للاعب
            await db.collection("players").doc(playerUID).collection("notifications").add({
                msg: `✅ مبروك! تم قبول انضمامك لبطولة: ${tourName}`,
                time: Date.now(),
                read: false
            });
            alert("تم قبول اللاعب وإرسال إشعار له");
        } else {
            await db.collection("playerRequests").doc(reqId).delete();
            alert("تم رفض الطلب");
        }
    }

    function loadPlayers() {
        db.collection("players").onSnapshot(snap => {
            const table = document.getElementById('allPlayersTable');
            table.innerHTML = "";
            snap.forEach(doc => {
                const p = doc.data();
                table.innerHTML += `
                    <tr>
                        <td>${p.nickname}</td>
                        <td>#${p.playerID}</td>
                        <td><input type="number" value="${p.gpPoints}" onchange="updateGP('${doc.id}', this.value)" style="width:70px"></td>
                        <td>${p.rank}</td>
                        <td>
                            <button onclick="toggleVerify('${doc.id}', ${p.isVerified})" class="btn" style="background:${p.isVerified?'#00f2ff':'#444'}">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            <button onclick="copyUID('${doc.id}')" class="btn" title="نسخ الـ UID"><i class="fas fa-copy"></i></button>
                        </td>
                    </tr>
                `;
            });
        });
    }

    async function updateGP(uid, val) {
        await db.collection("players").doc(uid).update({ gpPoints: parseInt(val) });
    }

    async function toggleVerify(uid, current) {
        await db.collection("players").doc(uid).update({ isVerified: !current });
    }

    function copyUID(uid) {
        navigator.clipboard.writeText(uid);
        alert("تم نسخ UID اللاعب لمراسلته");
    }

    async function sendPrivateMsg() {
        const uid = document.getElementById('targetUID').value;
        const txt = document.getElementById('privateMsgText').value;
        if(!uid || !txt) return alert("أدخل البيانات!");

        await db.collection("players").doc(uid).collection("notifications").add({
            msg: "✉️ رسالة خاصة من الإدارة: " + txt,
            time: Date.now(),
            read: false
        });
        alert("تم إرسال الرسالة بنجاح!");
        document.getElementById('privateMsgText').value = "";
    }

    async function updateNews() {
        const txt = document.getElementById('newsContent').value;
        await db.collection("settings").doc("ticker").set({ msg: txt });
        alert("تم تحديث شريط الأخبار في الموقع الرئيسي");
    }

    async function deleteTour(id) {
        if(confirm("هل أنت متأكد من حذف هذه البطولة؟")) {
            await db.collection("tournaments").doc(id).delete();
        }
    }
</script>
</body>
</html>
