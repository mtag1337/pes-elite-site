<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>

    <script src="https://pl28403518.effectivegatecpm.com/b5/4a/ca/b54aca8d89bd7e6d783f504a9c4ead80.js"></script>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1262927411271648"
     crossorigin="anonymous"></script>

     
    <meta charset="UTF-8">
    <title>PES ELITE - الملف الشخصي</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root { --main: #e1ff00; --bg: #0a0a0a; --card: #1a1a1a; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; }
        .profile-container { max-width: 500px; margin: auto; background: var(--card); padding: 30px; border-radius: 25px; border: 1px solid #333; }
        
        /* الصورة الشخصية */
        .avatar-box { position: relative; width: 120px; height: 120px; margin: 0 auto 20px; }
        #userImg { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--main); }
        .upload-label { position: absolute; bottom: 5px; right: 5px; background: var(--main); border-radius: 50%; width: 35px; height: 35px; cursor: pointer; color: black; line-height: 35px; font-weight: bold; }
        
        .form-group { text-align: right; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--main); font-size: 14px; }
        input { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 10px; box-sizing: border-box; }
        
        .save-btn { width: 100%; padding: 15px; background: var(--main); color: black; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .save-btn:disabled { background: #555; }
        #statusMsg { margin-top: 10px; font-size: 13px; color: #888; }
    </style>
</head>
<body>

<div class="profile-container">
    <div class="avatar-box">
        <img id="userImg" src="https://via.placeholder.com/120" alt="Profile">
        <label for="imgInput" class="upload-label">✎</label>
        <input type="file" id="imgInput" style="display: none;" accept="image/*">
    </div>

    <div class="form-group">
        <label>اسم الشهرة في الموقع:</label>
        <input type="text" id="nickInput" placeholder="اكتب اسمك">
    </div>

    <div class="form-group">
        <label>ID حساب eFootball (مهم جداً):</label>
        <input type="text" id="gameIdInput" placeholder="أدخل ID اللعبة الخاص بك">
    </div>

    <button id="saveBtn" class="save-btn" onclick="saveFullProfile()">حفظ كافة التغييرات</button>
    <p id="statusMsg"></p>
</div>

<script>
    // 1. عرض البيانات المخزنة عند فتح الصفحة
    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection("players").doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('nickInput').value = data.nickname || "";
                    document.getElementById('gameIdInput').value = data.efootballId || "";
                    if (data.profilePic) document.getElementById('userImg').src = data.profilePic;
                }
            });
        } else { window.location.href = "login.html"; }
    });

    // 2. وظيفة الحفظ الكاملة (صورة + بيانات)
    async function saveFullProfile() {
        const user = auth.currentUser;
        const nickname = document.getElementById('nickInput').value;
        const efootballId = document.getElementById('gameIdInput').value;
        const imageFile = document.getElementById('imgInput').files[0];
        const btn = document.getElementById('saveBtn');
        const msg = document.getElementById('statusMsg');

        if (!nickname || !efootballId) return alert("من فضلك ادخل الاسم والـ ID");

        btn.disabled = true;
        msg.innerText = "جاري الحفظ والرفع... انتظر لحظة";

        try {
            let photoUrl = document.getElementById('userImg').src;

            // لو اللاعب اختار صورة جديدة نرفعها للـ Storage
            if (imageFile) {
                const storageRef = firebase.storage().ref(`profiles/${user.uid}/avatar.jpg`);
                await storageRef.put(imageFile);
                photoUrl = await storageRef.getDownloadURL();
            }

            // تحديث البيانات في Firestore
            await db.collection("players").doc(user.uid).set({
                nickname: nickname,
                efootballId: efootballId,
                profilePic: photoUrl,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            msg.style.color = "#e1ff00";
            msg.innerText = "تم حفظ كل التعديلات بنجاح! ✅";
        } catch (error) {
            console.error(error);
            msg.style.color = "red";
            msg.innerText = "حدث خطأ أثناء الحفظ!";
        } finally {
            btn.disabled = false;
        }
    }

    // معاينة الصورة فور اختيارها
    document.getElementById('imgInput').onchange = function() {
        if (this.files && this.files[0]) {
            document.getElementById('userImg').src = URL.createObjectURL(this.files[0]);
        }
    };
</script>

</body>
</html>