<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PES ELITE | LEAGUE SYSTEM</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@700;900&family=Orbitron:wght@800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg: #050508; --neon: #00ff88; --accent: #00f2ff; --glass: rgba(255, 255, 255, 0.05); }
        body { background: var(--bg); color: white; font-family: 'Cairo', sans-serif; margin: 0; display: none; }
        
        /* شريط الأخبار */
        .news-ticker { background: #ff0055; color: white; padding: 12px; font-weight: bold; overflow: hidden; }
        
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; background: rgba(0,0,0,0.8); border-bottom: 2px solid var(--neon); }
        .container { max-width: 1100px; margin: auto; padding: 20px; }

        /* الجدول */
        .main-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .main-table tr { background: var(--glass); }
        .main-table th { padding: 15px; color: var(--neon); text-align: center; border-bottom: 2px solid #222; }
        .main-table td { padding: 18px; text-align: center; font-weight: 900; }
        
        .rank-box { font-family: 'Orbitron'; color: var(--neon); font-size: 22px; }
        .points-badge { background: var(--neon); color: black; padding: 5px 15px; border-radius: 8px; font-family: 'Orbitron'; }

        .nav-tabs { display: flex; gap: 10px; margin: 25px 0; justify-content: center; }
        .tab-btn { padding: 10px 25px; background: #111; border: 1px solid #333; color: white; cursor: pointer; border-radius: 10px; }
        .tab-btn.active { background: var(--neon); color: black; font-weight: bold; }

        .match-card { background: #0f0f15; border: 1px solid #222; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .score { font-family: 'Orbitron'; font-size: 24px; color: var(--accent); background: #000; padding: 5px 15px; border-radius: 5px; }
        
        .btn-ui { padding: 8px 15px; border-radius: 5px; border: none; cursor: pointer; font-family: 'Cairo'; font-weight: bold; text-decoration: none; font-size: 13px; }
    </style>
</head>
<body>

<div class="top-nav">
    <div style="font-family:'Orbitron'; font-size: 20px; font-weight:900;">PES <span style="color:var(--neon)">ELITE</span></div>
    <div style="display: flex; gap: 10px;">
        <a href="index.html" class="btn-ui" style="background: #333; color: white;">لوحة التحكم</a>
        <button onclick="auth.signOut()" class="btn-ui" style="background: #ff4d4d; color: white;">خروج</button>
    </div>
</div>

<div class="news-ticker">
    <marquee id="newsText">جاري تحميل آخر الأخبار...</marquee>
</div>

<div class="container">
    <div class="nav-tabs">
        <button id="t-btn" class="tab-btn active" onclick="show('table')">جدول الترتيب</button>
        <button id="m-btn" class="tab-btn" onclick="show('matches')">نتائج المباريات</button>
    </div>

    <div id="table-sec">
        <table class="main-table">
            <thead>
                <tr>
                    <th>مركز</th>
                    <th style="text-align: right;">اللاعب</th>
                    <th>لعب</th>
                    <th>فوز</th>
                    <th>نقاط</th>
                </tr>
            </thead>
            <tbody id="rows"></tbody>
        </table>
    </div>

    <div id="match-sec" style="display:none">
        <div id="list"></div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow", authDomain: "pes-elite.firebaseapp.com", projectId: "pes-elite", storageBucket: "pes-elite.firebasestorage.app", messagingSenderId: "407069539120", appId: "1:407069539120:web:466249fa7f716266d9e6f5" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), auth = firebase.auth();

    // فحص الدخول
    auth.onAuthStateChanged(user => {
        if(user) { document.body.style.display="block"; startApp(); }
        else { window.location.href="login.html"; }
    });

    function show(v) {
        document.getElementById('table-sec').style.display = v==='table'?'block':'none';
        document.getElementById('match-sec').style.display = v==='matches'?'block':'none';
        document.getElementById('t-btn').className = v==='table'?'tab-btn active':'tab-btn';
        document.getElementById('m-btn').className = v==='matches'?'tab-btn active':'tab-btn';
    }

    function startApp() {
        // 1. قراءة الأخبار المتغيرة
        db.collection("settings").doc("leagueConfig").onSnapshot(doc => {
            if(doc.exists) document.getElementById('newsText').innerText = doc.data().news;
        });

        // 2. قراءة المباريات وحساب الترتيب تلقائياً
        db.collection("leagueMatches").orderBy("time", "desc").onSnapshot(snap => {
            let pMap = {};
            let mHtml = "";
            
            snap.forEach(doc => {
                const d = doc.data();
                // حساب النقاط
                if(!pMap[d.player1]) pMap[d.player1] = { name: d.player1, pts: 0, pld: 0, wins: 0 };
                if(!pMap[d.player2]) pMap[d.player2] = { name: d.player2, pts: 0, pld: 0, wins: 0 };

                pMap[d.player1].pld++; pMap[d.player2].pld++;
                if(parseInt(d.score1) > parseInt(d.score2)) { pMap[d.player1].pts += 3; pMap[d.player1].wins++; }
                else if(parseInt(d.score2) > parseInt(d.score1)) { pMap[d.player2].pts += 3; pMap[d.player2].wins++; }
                else { pMap[d.player1].pts += 1; pMap[d.player2].pts += 1; }

                mHtml += `<div class="match-card">
                    <span style="width:30%">${d.player1}</span>
                    <span class="score">${d.score1} - ${d.score2}</span>
                    <span style="width:30%; text-align:left">${d.player2}</span>
                </div>`;
            });

            // تحديث الجدول
            let sorted = Object.values(pMap).sort((a,b) => b.pts - a.pts);
            let rHtml = "";
            sorted.forEach((p, i) => {
                rHtml += `<tr>
                    <td class="rank-box">${i+1}</td>
                    <td style="text-align:right">${p.name}</td>
                    <td>${p.pld}</td>
                    <td>${p.wins}</td>
                    <td><span class="points-badge">${p.pts}</span></td>
                </tr>`;
            });
            document.getElementById('rows').innerHTML = rHtml;
            document.getElementById('list').innerHTML = mHtml;
        });
    }
</script>
</body>
</html>
