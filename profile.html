<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PES ELITE - تعديل الملف الشخصي</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #e1ff00; --bg: #0a0a0a; --card: #16161a; --input: #222; }
        body { background: var(--bg); color: white; font-family: 'Cairo', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        
        .profile-container { width: 90%; max-width: 450px; background: var(--card); padding: 30px; border-radius: 25px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        h2 { text-align: center; color: var(--primary); margin-bottom: 25px; font-weight: 900; }

        .avatar-box { position: relative; width: 130px; height: 130px; margin: 0 auto 30px; }
        #userImg { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); background: #333; }
        .upload-label { position: absolute; bottom: 5px; right: 5px; background: var(--primary); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; color: black; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.3s; }
        .upload-label:hover { transform: scale(1.1); }
        
        .form-group { text-align: right; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; font-size: 14px; padding-right: 5px; }
        input { width: 100%; padding: 14px; background: var(--input); border: 1px solid #444; color: white; border-radius: 12px; font-family: 'Cairo'; transition: 0.3s; }
        input:focus { border-color: var(--primary); outline: none; background: #2a2a2a; }
        
        .save-btn { width: 100%; padding: 15px; background: var(--primary); color: black; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; font-size: 16px; transition: 0.3s; margin-top: 10px; }
        .save-btn:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .save-btn:disabled { background: #555; cursor: not-allowed; transform: none; }

        .back-link { display: block; text-align: center; margin-top: 20px; color: #888; text-decoration: none; font-size: 14px; transition: 0.3s; }
        .back-link:hover { color: var(--primary); }

        #statusMsg { margin-top: 15px; font-size: 14px; text-align: center; min-height: 20px; }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .5em 0 0 rgba(0,0,0,0), 1em 0 0 rgba(0,0,0,0); } 40% { color: var(--primary); text-shadow: .5em 0 0 rgba(0,0,0,0), 1em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .5em 0 0 var(--primary), 1em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .5em 0 0 var(--primary), 1em 0 0 var(--primary); } }
    </style>
</head>
<body>

<div class="profile-container">
    <h2>تعديل البيانات</h2>
    
    <div class="avatar-box">
        <img id="userImg" src="https://via.placeholder.com/130" alt="Profile">
        <label for="imgInput" class="upload-label"><i class="fas fa-camera"></i></label>
        <input type="file" id="imgInput" style="display: none;" accept="image/*">
    </div>

    <div class="form-group">
        <label><i class="fas fa-user"></i> اسم الشهرة (Nickname):</label>
        <input type="text" id="nickInput" placeholder="اكتب اسمك اللي هيظهر للناس">
    </div>

    <div class="form-group">
        <label><i class="fas fa-fingerprint"></i> eFootball ID:</label>
        <input type="text" id="gameIdInput" placeholder="أدخل ID اللعبة الخاص بك">
    </div>

    <button id="saveBtn" class="save-btn" onclick="saveFullProfile()">حفظ كافة التغييرات</button>
    <a href="index.html" class="back-link">العودة للرئيسية</a>
    <p id="statusMsg"></p>
</div>

<script>
    // الإعدادات (نفس الموجودة في index)
    const firebaseConfig = {
        apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
        authDomain: "pes-elite.firebaseapp.com",
        projectId: "pes-elite",
        storageBucket: "pes-elite.firebasestorage.app",
        messagingSenderId: "407069539120",
        appId: "1:407069539120:web:466249fa7f716266d9e6f5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // 1. جلب البيانات الحالية
    auth.onAuthStateChanged(user => {
        if (user) {
            db.collection("players").doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('nickInput').value = data.nickname || "";
                    document.getElementById('gameIdInput').value = data.efootballId || "";
                    // استخدام photoURL للتوحيد
                    if (data.photoURL) document.getElementById('userImg').src = data.photoURL;
                }
            });
        } else {
            window.location.href = "login.html";
        }
    });

    // 2. وظيفة الحفظ الاحترافية
    async function saveFullProfile() {
        const user = auth.currentUser;
        const nickname = document.getElementById('nickInput').value.trim();
        const efootballId = document.getElementById('gameIdInput').value.trim();
        const imageFile = document.getElementById('imgInput').files[0];
        const btn = document.getElementById('saveBtn');
        const msg = document.getElementById('statusMsg');

        if (!nickname || !efootballId) {
            msg.style.color = "#ff4d4d";
            msg.innerText = "⚠️ من فضلك أكمل البيانات الأساسية";
            return;
        }

        btn.disabled = true;
        msg.style.color = "var(--primary)";
        msg.innerHTML = '<span class="loading-dots">جاري الحفظ والرفع</span>';

        try {
            let finalPhotoUrl = document.getElementById('userImg').src;

            // رفع الصورة لو تغيرت
            if (imageFile) {
                const storageRef = storage.ref(`profiles/${user.uid}/avatar.jpg`);
                await storageRef.put(imageFile);
                finalPhotoUrl = await storageRef.getDownloadURL();
            }

            // تحديث Firestore ببيانات موحدة
            await db.collection("players").doc(user.uid).set({
                nickname: nickname,
                efootballId: efootballId,
                photoURL: finalPhotoUrl, // التوحيد هنا
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            msg.style.color = "#00ff88";
            msg.innerText = "✅ تم تحديث ملفك الشخصي بنجاح!";
            
            // العودة للرئيسية بعد ثانية ونصف
            setTimeout(() => { window.location.href = "index.html"; }, 1500);

        } catch (error) {
            console.error(error);
            msg.style.color = "#ff4d4d";
            msg.innerText = "❌ فشل التحديث: " + error.message;
            btn.disabled = false;
        }
    }

    // معاينة الصورة الفورية
    document.getElementById('imgInput').onchange = function() {
        if (this.files && this.files[0]) {
            document.getElementById('userImg').src = URL.createObjectURL(this.files[0]);
        }
    };
</script>

</body>
</html>
