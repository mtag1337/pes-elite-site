<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>PES ELITE | نظام الإدارة المطور</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #e1ff00; --bg: #050508; --card: #111118; }
        body { background: var(--bg); color: white; font-family: 'Cairo'; margin: 0; padding: 20px; }
        .grid-admin { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        h2 { color: var(--primary); border-bottom: 1px solid #333; padding-bottom: 10px; }
        input, select, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none; }
        input { background: #000; color: #fff; border: 1px solid #333; }
        button { cursor: pointer; font-weight: bold; background: var(--primary); color: #000; }
        .req-box { background: #1a1a24; padding: 15px; border-radius: 10px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-approve { background: #00ff88; width: auto; padding: 5px 15px; }
        .btn-reject { background: #ff4d4d; width: auto; padding: 5px 15px; }
    </style>
</head>
<body>

<h1><i class="fas fa-tools"></i> لوحة التحكم المتقدمة</h1>

<div class="grid-admin">
    <div class="card">
        <h2><i class="fas fa-trophy"></i> إنشاء بطولة جديدة</h2>
        <input type="text" id="tourTitle" placeholder="اسم البطولة (مثلاً: كاس النخبة)">
        <input type="text" id="tourPrize" placeholder="الجائزة (مثلاً: 5000 GP)">
        <button onclick="createNewTournament()">نشر البطولة للمستخدمين</button>
    </div>

    <div class="card">
        <h2><i class="fas fa-user-plus"></i> طلبات الانضمام المعلقة</h2>
        <div id="pendingRequests">جاري تحميل الطلبات...</div>
    </div>
</div>

<div class="card">
    <h2><i class="fas fa-bell"></i> إرسال إشعار عام لكل اللاعبين</h2>
    <input type="text" id="globalNotice" placeholder="اكتب نص الإشعار هنا...">
    <button style="background: #00bfff;" onclick="sendGlobalNotification()">إرسال إشعار</button>
</div>

<script>
    // ضع إعدادات Firebase الخاصة بك هنا
    const firebaseConfig = {
        apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
        authDomain: "pes-elite.firebaseapp.com",
        projectId: "pes-elite",
        storageBucket: "pes-elite.firebasestorage.app",
        messagingSenderId: "407069539120",
        appId: "1:407069539120:web:466249fa7f716266d9e6f5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 1. وظيفة إنشاء بطولة
    async function createNewTournament() {
        const title = document.getElementById('tourTitle').value;
        const prize = document.getElementById('tourPrize').value;
        if(!title || !prize) return alert("أكمل البيانات");

        await db.collection("tournaments").add({
            title: title,
            prize: prize,
            status: "open",
            createdAt: Date.now()
        });
        alert("تم نشر البطولة!");
    }

    // 2. تحميل طلبات الانضمام وقبولها
    function loadRequests() {
        db.collection("playerRequests").where("status", "==", "pending").onSnapshot(snap => {
            const div = document.getElementById('pendingRequests');
            div.innerHTML = "";
            snap.forEach(doc => {
                const r = doc.data();
                div.innerHTML += `
                    <div class="req-box">
                        <div>
                            <b>${r.playerName}</b><br>
                            <small>البطولة: ${r.tournamentName}</small>
                        </div>
                        <div>
                            <button class="btn-approve" onclick="actionRequest('${doc.id}', '${r.uid}', 'approved', '${r.tournamentName}')">قبول</button>
                            <button class="btn-reject" onclick="actionRequest('${doc.id}', '${r.uid}', 'rejected', '${r.tournamentName}')">رفض</button>
                        </div>
                    </div>
                `;
            });
        });
    }

    async function actionRequest(docId, userId, newStatus, tName) {
        // 1. تحديث حالة الطلب
        await db.collection("playerRequests").doc(docId).update({ status: newStatus });
        
        // 2. إرسال إشعار خاص للاعب
        const msg = newStatus === 'approved' ? `مبروك! تم قبولك في بطولة ${tName}` : `نعتذر، تم رفض طلبك في ${tName}`;
        await db.collection("notifications").add({
            to: userId,
            text: msg,
            time: Date.now(),
            read: false
        });
        alert("تمت العملية وإرسال إشعار للاعب");
    }

    // 3. إرسال إشعار عام
    async function sendGlobalNotification() {
        const txt = document.getElementById('globalNotice').value;
        if(!txt) return;
        await db.collection("notifications").add({
            to: "all",
            text: txt,
            time: Date.now(),
            read: false
        });
        alert("تم إرسال الإشعار للجميع!");
    }

    loadRequests();
</script>
</body>
</html>
