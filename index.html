<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PES ELITE | ساحة البطولة</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --ef-blue: #0014d3; --ef-yellow: #eaff00; --ef-pink: #ff007a;
            --dark-bg: #050508; --card-bg: #111118;
        }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--dark-bg); color: white; }
        
        /* Navbar */
        .navbar { background: #000; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--ef-blue); position: sticky; top: 0; z-index: 1000; }
        .logo { font-family: 'Orbitron'; font-size: 24px; color: var(--ef-yellow); text-decoration: none; }
        .user-info { display: flex; align-items: center; gap: 15px; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* Tournament Cards */
        .section-title { font-family: 'Orbitron'; border-right: 4px solid var(--ef-pink); padding-right: 15px; margin-bottom: 25px; color: var(--ef-yellow); }
        .tour-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tour-card { background: var(--card-bg); border-radius: 20px; overflow: hidden; border: 1px solid #222; transition: 0.3s; }
        .tour-card:hover { transform: translateY(-10px); border-color: var(--ef-blue); }
        .tour-banner { height: 150px; background-size: cover; background-position: center; position: relative; }
        .tour-content { padding: 20px; }
        .tour-badge { background: var(--ef-blue); padding: 5px 12px; border-radius: 5px; font-size: 12px; position: absolute; top: 10px; right: 10px; }

        .btn-join { width: 100%; padding: 12px; background: var(--ef-pink); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn-join:disabled { background: #444; cursor: not-allowed; }

        /* Matches Table */
        .glass-card { background: var(--card-bg); padding: 25px; border-radius: 20px; border: 1px solid #222; margin-top: 40px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { color: #666; text-align: center; padding: 15px; border-bottom: 1px solid #222; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #111; }
        .score-box { background: #000; padding: 5px 15px; border-radius: 5px; font-family: 'Orbitron'; color: var(--ef-yellow); }

        .news-ticker { background: var(--ef-pink); color: white; padding: 10px; overflow: hidden; white-space: nowrap; }
        .news-ticker span { display: inline-block; animation: marquee 20s linear infinite; font-weight: bold; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body>

    <div class="news-ticker"><span id="tickerNews">تحميل آخر الأخبار...</span></div>

    <nav class="navbar">
        <a href="#" class="logo">PES ELITE</a>
        <div class="user-info">
            <span id="userName" style="font-weight: bold;">...</span>
            <button onclick="auth.signOut()" style="background:none; border:none; color:var(--ef-pink); cursor:pointer;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </nav>

    <div class="container">
        <h2 class="section-title">البطولات النشطة</h2>
        <div class="tour-grid" id="toursList">
            </div>

        <div class="glass-card">
            <h2 class="section-title" style="border-color: var(--ef-blue);">مبارياتي القادمة</h2>
            <table>
                <thead>
                    <tr>
                        <th>البطولة</th>
                        <th>الخصم</th>
                        <th>النتيجة</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody id="myMatches">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
            authDomain: "pes-elite.firebaseapp.com",
            projectId: "pes-elite",
            storageBucket: "pes-elite.firebasestorage.app",
            messagingSenderId: "407069539120",
            appId: "1:407069539120:web:466249fa7f716266d9e6f5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(), auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if(!user) window.location.href="login.html";
            else {
                document.getElementById('userName').innerText = user.displayName || user.email;
                loadTours();
                loadMyMatches(user.email);
                loadNews();
            }
        });

        // 1. تحميل الأخبار من الـ Admin
        function loadNews() {
            db.collection("settings").doc("leagueConfig").onSnapshot(doc => {
                if(doc.exists) document.getElementById('tickerNews').innerText = doc.data().news;
            });
        }

        // 2. تحميل البطولات المتاحة للاشتراك
        function loadTours() {
            db.collection("tournaments").onSnapshot(snap => {
                let html = "";
                snap.forEach(doc => {
                    const t = doc.data();
                    html += `
                        <div class="tour-card">
                            <div class="tour-banner" style="background-image: url('${t.logo || 'https://via.placeholder.com/300x150'}')">
                                <span class="tour-badge">${t.type == 'league' ? 'دوري' : 'تصفيات'}</span>
                            </div>
                            <div class="tour-content">
                                <h3 style="margin-top:0">${t.name}</h3>
                                <p style="color:#888; font-size:14px;"><i class="fas fa-gift"></i> الجائزة: ${t.prize}</p>
                                <button class="btn-join" onclick="joinRequest('${doc.id}', '${t.name}')">طلب انضمام للبطولة</button>
                            </div>
                        </div>`;
                });
                document.getElementById('toursList').innerHTML = html;
            });
        }

        // 3. إرسال طلب انضمام للـ Admin
        async function joinRequest(tId, tName) {
            const user = auth.currentUser;
            await db.collection("joinRequests").add({
                tourId: tId,
                tourName: tName,
                playerEmail: user.email,
                playerName: user.displayName || user.email,
                status: "pending",
                time: new Date()
            });
            alert("تم إرسال طلبك للإدارة! انتظر الموافقة للبدء.");
        }

        // 4. تحميل مباريات اللاعب الحالية (فقط مبارياته هو)
        function loadMyMatches(email) {
            db.collection("leagueMatches")
              .where("status", "==", "scheduled")
              .onSnapshot(snap => {
                let html = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    // فلترة: هل اللاعب أحد طرفي المباراة؟
                    if(m.player1 === email || m.player2 === email) {
                        const opponent = (m.player1 === email) ? m.player2 : m.player1;
                        html += `
                            <tr>
                                <td>${m.tournamentId}</td> <td>${opponent}</td>
                                <td><span class="score-box">${m.score1} - ${m.score2}</span></td>
                                <td style="color:var(--ef-yellow)">مجدولة</td>
                            </tr>`;
                    }
                });
                document.getElementById('myMatches').innerHTML = html || "<tr><td colspan='4'>لا توجد مباريات قادمة حالياً</td></tr>";
            });
        }
    </script>
</body>
</html>

