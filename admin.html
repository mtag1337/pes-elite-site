<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>إدارة PES ELITE | التحكم الكامل</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --p: #e1ff00; --bg: #050508; --card: #111118; --danger: #ff4d4d; }
        body { background: var(--bg); color: white; font-family: 'Cairo'; margin: 0; padding: 20px; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #222; margin-bottom: 20px; }
        h2 { color: var(--p); font-size: 18px; border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 0; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; font-family: 'Cairo'; }
        input, select { background: #000; color: #fff; border: 1px solid #333; }
        button { cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-add { background: var(--p); color: #000; }
        .btn-del { background: var(--danger); color: #fff; padding: 5px; font-size: 12px; width: auto; }
        .item-list { max-height: 200px; overflow-y: auto; background: #000; padding: 10px; border-radius: 8px; }
        .list-entry { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #222; }
        .init-btn { background: #555; color: #fff; font-size: 10px; padding: 5px; width: auto; margin-top: 10px; }
    </style>
</head>
<body>

<h1><i class="fas fa-user-shield"></i> مركز إدارة العمليات</h1>

<div class="admin-grid">

    <div class="card">
        <h2><i class="fas fa-trophy"></i> إدارة البطولات الحالية</h2>
        <input type="text" id="tTitle" placeholder="اسم البطولة">
        <input type="text" id="tPrize" placeholder="الجائزة">
        <button class="btn-add" onclick="createT()">إنشاء بطولة جديدة</button>
        <hr>
        <div id="tList" class="item-list"></div>
    </div>

    <div class="card">
        <h2><i class="fas fa-edit"></i> تحديث نقاط الدوري</h2>
        <p style="font-size: 12px; color: #888;">اختر اللاعب وعدل أرقامه التراكمية</p>
        <select id="targetPlayer">
            <option value="">اختر اللاعب من الدوري</option>
        </select>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <input type="number" id="plusW" placeholder="+ فوز">
            <input type="number" id="plusD" placeholder="+ تعادل">
            <input type="number" id="plusL" placeholder="+ خسارة">
            <input type="number" id="plusGF" placeholder="+ أهداف له">
            <input type="number" id="plusGA" placeholder="+ أهداف عليه">
        </div>
        <button class="btn-add" style="background:#00bfff; color:white;" onclick="updatePlayerStats()">تحديث في الجدول</button>
        <button class="init-btn" onclick="initializeLeague()">تهيئة الـ 15 خانة (مرة واحدة فقط)</button>
    </div>

    <div class="card">
        <h2><i class="fas fa-id-card"></i> طلبات الانضمام</h2>
        <div id="reqs" class="item-list"></div>
        <hr>
        <h2><i class="fas fa-users-cog"></i> إسناد فريق للاعب</h2>
        <select id="allPlayersList"><option value="">اختر لاعباً من الموقع</option></select>
        <input type="text" id="teamName" placeholder="اسم الفريق (مثل: الأهلي)">
        <button class="btn-add" style="background:white; color:black;" onclick="assignTeam()">حفظ الفريق</button>
    </div>

</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCYAtj7gB7bfXPPSRojddCzhIyUMN7Tnow",
        authDomain: "pes-elite.firebaseapp.com",
        projectId: "pes-elite",
        storageBucket: "pes-elite.firebasestorage.app",
        messagingSenderId: "407069539120",
        appId: "1:407069539120:web:466249fa7f716266d9e6f5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    window.onload = () => {
        loadTournaments();
        loadPlayers();
        loadRequests();
        loadLeaguePlayers(); // تحميل الـ 15 لاعب في القائمة
    };

    // إنشاء بطولة
    async function createT() {
        const title = document.getElementById('tTitle').value;
        const prize = document.getElementById('tPrize').value;
        if (title) {
            await db.collection("tournaments").add({ title, prize, status: "open", time: Date.now() });
            alert("تمت إضافة البطولة");
            location.reload();
        }
    }

    // تحميل البطولات للحذف
    function loadTournaments() {
        db.collection("tournaments").onSnapshot(snap => {
            const container = document.getElementById('tList');
            container.innerHTML = "";
            snap.forEach(doc => {
                container.innerHTML += `
                    <div class="list-entry">
                        <span>${doc.data().title}</span>
                        <button class="btn-del" onclick="deleteDoc('tournaments', '${doc.id}')">حذف</button>
                    </div>`;
            });
        });
    }

    // تهيئة الدوري لـ 15 فريق (تستخدمها مرة واحدة فقط في البداية)
    async function initializeLeague() {
        if(!confirm("هل تريد إنشاء 15 خانة فارغة في الدوري؟")) return;
        for (let i = 1; i <= 15; i++) {
            await db.collection("leaguePlayers").add({
                nickname: "فريق فارغ " + i,
                pts: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, played: 0, gd: 0
            });
        }
        alert("تمت التهيئة! يمكنك الآن تعديل أسمائهم ونقاطهم.");
        location.reload();
    }

    // تحميل أسماء لاعبي الدوري في القائمة المنسدلة
    function loadLeaguePlayers() {
        db.collection("leaguePlayers").onSnapshot(snap => {
            const select = document.getElementById('targetPlayer');
            select.innerHTML = '<option value="">اختر اللاعب من الدوري</option>';
            snap.forEach(doc => {
                select.innerHTML += `<option value="${doc.id}">${doc.data().nickname}</option>`;
            });
        });
    }

    // تحديث النقاط التراكمي
    async function updatePlayerStats() {
        const uid = document.getElementById('targetPlayer').value;
        const w = parseInt(document.getElementById('plusW').value) || 0;
        const d = parseInt(document.getElementById('plusD').value) || 0;
        const l = parseInt(document.getElementById('plusL').value) || 0;
        const gf = parseInt(document.getElementById('plusGF').value) || 0;
        const ga = parseInt(document.getElementById('plusGA').value) || 0;

        if(!uid) return alert("اختر لاعب أولاً");

        const ref = db.collection("leaguePlayers").doc(uid);
        const doc = await ref.get();
        let current = doc.data();

        const newW = current.w + w;
        const newD = current.d + d;
        const newL = current.l + l;

        await ref.update({
            played: current.played + (w + d + l),
            w: newW,
            d: newD,
            l: newL,
            gf: current.gf + gf,
            ga: current.ga + ga,
            pts: (newW * 3) + (newD * 1),
            gd: (current.gf + gf) - (current.ga + ga)
        });

        alert("تم تحديث ترتيب اللاعب!");
        // تصغير القيم بعد الإضافة لعدم التكرار بالخطأ
        document.getElementById('plusW').value = "";
        document.getElementById('plusD').value = "";
        document.getElementById('plusL').value = "";
        document.getElementById('plusGF').value = "";
        document.getElementById('plusGA').value = "";
    }

    // وظائف عامة
    function loadPlayers() {
        db.collection("players").get().then(snap => {
            const s3 = document.getElementById('allPlayersList');
            snap.forEach(doc => {
                s3.innerHTML += `<option value="${doc.id}">${doc.data().nickname || doc.data().name}</option>`;
            });
        });
    }

    async function assignTeam() {
        const uid = document.getElementById('allPlayersList').value;
        const team = document.getElementById('teamName').value;
        if(uid && team) {
            await db.collection("players").doc(uid).update({ assignedTeam: team });
            alert("تم إسناد الفريق");
        }
    }

    function deleteDoc(col, id) {
        if(confirm("حذف نهائي؟")) db.collection(col).doc(id).delete();
    }

    function loadRequests() {
        db.collection("playerRequests").onSnapshot(snap => {
            const container = document.getElementById('reqs');
            container.innerHTML = "";
            snap.forEach(doc => {
                container.innerHTML += `
                    <div class="list-entry">
                        <span>${doc.data().playerName}</span>
                        <button class="btn-del" style="background:green" onclick="deleteDoc('playerRequests', '${doc.id}')">قبول</button>
                    </div>`;
            });
        });
    }
</script>
</body>
</html>
